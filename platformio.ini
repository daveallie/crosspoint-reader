[platformio]
crosspoint_version = 0.12.0
default_envs = default

[base]
platform = espressif32 @ 6.12.0
board = esp32-c3-devkitm-1
framework = arduino
monitor_speed = 115200
upload_speed = 921600
check_tool = cppcheck
check_flags = --enable=all --suppress=missingIncludeSystem --suppress=unusedFunction --suppress=unmatchedSuppression --suppress=*:*/.pio/* --inline-suppr
check_skip_packages = yes

board_upload.flash_size = 16MB
board_upload.maximum_size = 16777216
board_upload.offset_address = 0x10000

build_flags =
  -DARDUINO_USB_MODE=1
  -DARDUINO_USB_CDC_ON_BOOT=1
  -DMINIZ_NO_ZLIB_COMPATIBLE_NAMES=1
  -DEINK_DISPLAY_SINGLE_BUFFER_MODE=1
  -DDISABLE_FS_H_WARNING=1
# https://libexpat.github.io/doc/api/latest/#XML_GE
  -DXML_GE=0
  -DXML_CONTEXT_BYTES=1024
  -std=c++2a
# Enable UTF-8 long file names in SdFat
  -DUSE_UTF8_LONG_NAMES=1
# LWIP TCP/IP stack optimizations for WiFi file transfer performance
# These settings optimize buffer sizes and TCP parameters for maximum throughput
  -DCONFIG_LWIP_MAX_SOCKETS=10
  -DCONFIG_LWIP_TCP_MSS=1436
  -DCONFIG_LWIP_TCP_SND_BUF_DEFAULT=5744
  -DCONFIG_LWIP_TCP_WND_DEFAULT=5744
  -DCONFIG_LWIP_TCP_RECVMBOX_SIZE=12
  -DCONFIG_LWIP_UDP_RECVMBOX_SIZE=12
  -DCONFIG_LWIP_TCPIP_RECVMBOX_SIZE=32
  -DCONFIG_LWIP_TCP_RTO_TIME=3000
# WiFi performance optimizations
  -DCONFIG_ESP32_WIFI_STATIC_RX_BUFFER_NUM=16
  -DCONFIG_ESP32_WIFI_DYNAMIC_RX_BUFFER_NUM=32
  -DCONFIG_ESP32_WIFI_TX_BUFFER_TYPE=1
  -DCONFIG_ESP32_WIFI_DYNAMIC_TX_BUFFER_NUM=32
# TCP optimizations for file uploads
  -DCONFIG_LWIP_TCP_OVERSIZE=1
  -DCONFIG_LWIP_WND_SCALE=1
  -DCONFIG_LWIP_TCP_RCV_SCALE=2

; Board configuration
board_build.flash_mode = dio
board_build.flash_size = 16MB
board_build.partitions = partitions.csv

extra_scripts =
  pre:scripts/build_html.py

; Libraries
lib_deps =
  BatteryMonitor=symlink://open-x4-sdk/libs/hardware/BatteryMonitor
  InputManager=symlink://open-x4-sdk/libs/hardware/InputManager
  EInkDisplay=symlink://open-x4-sdk/libs/display/EInkDisplay
  SDCardManager=symlink://open-x4-sdk/libs/hardware/SDCardManager
  ArduinoJson @ 7.4.2
  QRCode @ 0.0.1

[env:default]
extends = base
build_flags =
  ${base.build_flags}
  -DCROSSPOINT_VERSION=\"${platformio.crosspoint_version}-dev\"

[env:gh_release]
extends = base
build_flags =
  ${base.build_flags}
  -DCROSSPOINT_VERSION=\"${platformio.crosspoint_version}\"
